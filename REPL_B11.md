# REPL_B11
> 此case用来做升级；
Upgrade replv1 to replv2 follwing by the below steps:

1. Setup replv1


## replv1—> replv2的升级
先setup replv1
用asmca看dg的attribute，发现是 18.0.0.0.0
重建diskgroup，指定 compatible.advm 11.2.0.4

1.添加primary and standby site information in file tnsnames.ora under /scratch/oracle/CrsHome/network/admin/tnsnames.ora

 # Generated by Oracle configuration tools.
primary =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = rwsae01.us.oracle.com)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = +ASM_P)
    )
  )
standby =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = rwsae04.us.oracle.com)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = +ASM_S)
    )
  )
并scp到另外节点上

3. create ASMADMIN user used for ACFS replication: 

>  export ORACLE_SID=+ASM1
>  export ORACLE_HOME=/scratch/oracle/CrsHome
>  export PATH=$ORACLE_HOME/bin:$PATH
>  sqlplus "/as sysasm"
>  ps -ef|grep asm_smon

*yuyao脚本set_my_env.sh里面的alias*
>  asql

Execute the following statement on all ASM instances on one node(on both sites): 

SQL>create user rep identified by rep default tablespace rep;

SQL>grant sysasm to rep; 

注意：
1.
[rwsae01]:[20:52:03]:[/scratch/crsusr]:$ asql
SQL*Plus: Release 18.0.0.0.0 Development on Mon Sep 4 20:52:09 2017
Copyright (c) 1982, 2017, Oracle.  All rights reserved.

Connected to:
Oracle Database 2018 Enterprise Edition Release 18.0.0.0.0 - Development
SQL> create user rep identified by rep default tablespace rep;
User created.
SQL>

2.报错：
Message file sp1<lang>.msb not found
SP2-0750: You may need to set ORACLE_HOME to your Oracle software directory
Stack Overflow解答：
Usually the msb file not found problems are the result of an environment setting problem, but in your case I'm a little suspicious of the installation (I've never used the apt-get + configure method).

To check the sanity of the installation:
ORACLE_HOME should be set to a directory path one level above the bin directory where sqlplus executable is found.
There should some .msb files under $ORACLE_HOME/sqlplus/mesg
There should be hundreds (not sure of the number with XE) of .msb files under $ORACLE_HOME (try find $ORACLE_HOME -name "*.msb" -print to show them)
Your PATH should include $ORACLE_HOME/bin.
All files under ORACLE_HOME should be owned by user:oracle group:dba.

4. Initiate replication: 

4.1 先初始化 standby replication on the standby site by root: 初始化stand时候要求他的ACFS只能mount到当前那个node，且root来执行
on rwsae04
<<==stop standby filesystem on other nodes

[Tue Sep 05 00:45:45 ][root@rwsae04.us.oracle.com:/scratch/oracle/CrsHome/bin]#./srvctl stop filesystem -diskgroup srsp -volume volume3 -node rwsae01
[Tue Sep 05 00:47:50 ][root@rwsae04.us.oracle.com:/scratch/oracle/CrsHome/bin]#./srvctl stop filesystem -diskgroup srsp -volume volume3 -node rwsae03
[Tue Sep 05 00:47:54 ][root@rwsae04.us.oracle.com:/scratch/oracle/CrsHome/bin]#

[Tue Sep 05 00:48:06 ][root@rwsae04.us.oracle.com:/scratch/oracle/CrsHome/bin]#acfsutil repl init standby -F -p rep/rep@primary -d 6 -c +ASM_S /scratch/crsusr/mount/sta/
Registering with user specified service name-+ASM_S

> 需要加-c 否则hit ACFS-05022: internal CRS error
to check if replication is initiated successfully. 
[Tue Oct 22 02:13:24][crsusr@rwsae04:~]$ acfsutil repl info -c /scratch/crsusr/mount/sta/
Site:                                Standby
Standby status:                      Online
Last sync time with primary:         Tue Oct 22 02:08:35 2013


Background Resources:                4 of 4 Online
Standby mount point:                 /scratch/crsusr/mount/sta/
Standby Oracle Net service name:     +ASM_S
Primary mount point:                 /scratch/crsusr/mount/pri/
Primary Oracle Net service name:     +ASM_P
Primary Oracle Net alias:            rep/****@primary
Replicated tags:                     
Log compression:                     On
Debug log level:      
<<<==start standby filesystem               6

然后start other nodes:
[Tue Sep 05 00:26:12 ][root@rwsae04.us.oracle.com:/scratch/oracle/CrsHome/bin]#./srvctl start filesystem -diskgroup srsp -volume volume3 -node rwsae01
[Tue Sep 05 00:26:51 ][root@rwsae04.us.oracle.com:/scratch/oracle/CrsHome/bin]#./srvctl start filesystem -diskgroup srsp -volume volume3 -node rwsae03

4.2. 然后初始化primary on the primary site: 
on rwsae01 

[Tue Sep 05 00:48:32][9459][root@rwsae01.us.oracle.com:~][1]# acfsutil repl init primary -F -s rep/rep@standby  -d 6 -c  +ASM_P /scratch/crsusr/mount/pri/ -m /scratch/crsusr/mount/sta/
validating the remote connection
remote connection has been established
Registering with user specified service name-+ASM_P
waiting for the standby replication site to initialize
waiting for the standby replication site to initialize
waiting for the standby replication site to initialize
waiting for the standby replication site to initialize
waiting for the standby replication site to initialize
waiting for the standby replication site to initialize
waiting for the standby replication site to initialize
waiting for the standby replication site to initialize
The standby replication site is initialized. ACFS replication will begin.


//如果在standby init 会不停的显示waiting for the standby replication site to initialize，需要加 -m否则报+ASM_P未注册orACFS-05065: cannot transfer 
to check if replication is initiated successfully. 
-bash-4.1$  acfsutil repl info -c /scratch/crsusr/mount/pri/
Site:                                Primary
Lag Time:                            00:00:00
Primary status:                      Online
Background Resources:                3 of 3 Online
Primary mount point:                 /scratch/crsusr/mount/pri/
Primary Oracle Net service name:     +ASM_P
Standby mount point:                 /scratch/crsusr/mount/sta/
Standby Oracle Net service name:     +ASM_S
Standby Oracle Net alias:            rep/****@standby
Replicated tags:                     
Log compression:                     On
Debug log level:                     6


2. Prepare on primary.
acfsutil repl upgrade prepare 

> Before you start the upgrade procedure, you must ensure that the primary file system is mounted on only one node of its cluster. 

[Tue Sep 05 01:34:57][9459][root@rwsae01.us.oracle.com:/scratch/oracle/CrsHome/bin][1]# acfsutil repl upgrade prepare -s crsusr@rwsae04 /scratch/crsusr/mount/pri/

3. Upgrade standby.
acfsutil repl upgrade standby 

[Tue Sep 05 01:37:50 ][root@rwsae04.us.oracle.com:/scratch/oracle/CrsHome/bin]#acfsutil repl upgrade standby /scratch/crsusr/mount/sta/
acfsutil repl upgrade standby: ACFS-05060: waiting for ACFS replication to terminate

4. Upgrade primary.
acfsutil repl upgrade primary 

[Tue Sep 05 01:39:19][9459][root@rwsae01.us.oracle.com:/scratch/oracle/CrsHome/bin][0]# acfsutil repl upgrade primary -C -d 6 -z on /scratch/crsusr/mount/pri/

验证：
[Tue Sep 05 01:48:36][9459][root@rwsae01.us.oracle.com:/scratch/oracle/CrsHome/bin][0]# acfsutil repl upgrade primary -C -d 6 -z on /scratch/crsusr/mount/pri/
acfsutil repl upgrade primary: ACFS-05907: The ACFS file system mounted at path /scratch/crsusr/mount/pri/ is already running the latest version of replication.



Variant: 
1.During repl upgrade,try destructive tests such as  node reboot/process crash/asm crash and so on.
2. Before upgrade,enable sec/encr.
3. During upgrade,do IO workload running.

